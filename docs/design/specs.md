# 仕様ドキュメント設計

## 目的

`docs/specs/` ディレクトリ配下で管理する「仕様ドキュメント」の目的は、LLMに必要なコンテキストを明示的に提供することにある。
セッションをまたいでも、設計思想に沿ったコード変更を行えるようにする。

対象読者はLLMおよびこのプロジェクトを保守する人間の両方。

## 仕様ドキュメントの設計思想

LLMにはセッションごとにメモリがリセットされるという特性がある。
また、ファイル探索ツール（Explorer）でたまたま見つけた情報に引っ張られる傾向がある。
質の高い情報を明示的に提供することで、設計思想に沿ったコード変更を促す。
以上の前提から、次の方針を採用する。

- **ドキュメントを読んでから変更する**: LLMは `llms.txt` → `docs/specs/` の順で読み込み、その後コード変更を行う
- **意図的な冗長性をもたせる**: ファイルを見れば分かること（ファイル名とクラス名のマッピングなど）もあえて記載する。冗長に見えても、LLMに正確なコンテキストを与えるためには必要
- **設計の意図を明示する**: 「何があるか」だけでなく「なぜそう設計したか」を記述する。意図が伝わらないと、LLMが合理的に見える別の設計へ変更するリスクがある

## 運用フロー

### コード変更前

LLMは以下の順で読み込む:

```
llms.txt（ドキュメントインデックス）
    ↓
specs/（対象モジュールの仕様書）
    ↓
コード変更
```

### コード変更後

コード変更後は必ず、仕様ドキュメントの同期タスクを追加する（`CLAUDE.md` の Plan Mode Constraints に記載済み）。

同期が漏れると、仕様ドキュメントが「高品質な誤情報」をLLMに与えることになる。
実装との乖離は有害であり、同期は必須。

## 構成ファイル

各モジュールの仕様ドキュメントは、最低限以下の2ファイルで構成する。

| ファイル | 内容 |
|---------|------|
| `requirements.md` | 要件定義。モジュールの目的・機能要件・品質要件・前提条件 |
| `design.md` | 基本設計。コンポーネント構成・設計の意図・ガードレール・変更ガイド・影響範囲 |

これら2ファイルでは収まらない情報（例：詳細なCLIインターフェース仕様、APIリファレンス）が存在する場合は、別ファイルを追加してよい。

## 記述ガイドライン

### requirements.md に含める情報

| 記述内容 | 説明 |
|---------|------|
| **目的と課題**（概要） | モジュールが何のために存在するか、解決する課題、提供するコンポーネントの概要 |
| **機能要件** | モジュールが実現する機能の一覧と仕様 |
| **品質要件** | 機能要件以外で満たすべき品質特性（不変性・テスト容易性・拡張性など） |
| **前提条件** | 技術基盤、利用シナリオ、外部との制約など |

### design.md に含める情報

| 記述内容 | 説明 |
|---------|------|
| **何があるか**（コンポーネント一覧・ファイルマッピング） | クラス名とファイル名の対応、パッケージ構成の全体像 |
| **なぜそう設計したか**（設計の意図・トレードオフ） | 採用した設計の理由、却下した代替案、制約の背景。設計の意図・判断理由・トレードオフの観点で記述する |
| **してはいけないこと**（ガードレール） | 壊してはいけない不変条件、混在させてはいけない責務 |
| **変更パターン別ガイド** | よくある変更パターンと対応ファイルの道筋 |
| **影響範囲** | パッケージの公開 API を変更した場合に影響を受ける呼び出し元 |

ファイルを読めば分かる情報でも、コンテキストとして有益なら記載してよい。
「冗長では？」という判断で削除すると、LLMが次のセッションで道に迷う原因になる。

## ガードレール

| ルール | 理由 |
|-------|------|
| 仕様ドキュメントと実装が乖離した場合は必ず同期する | 古い仕様ドキュメントは誤情報化し、LLMを誤った方向へ誘導する |
| 仕様ドキュメントを削除・大幅に簡略化してはならない | 冗長に見えても、LLMへの情報提供という意図がある |
