# Python開発ワークフロー

生成AIがPython開発タスクに取りかかるときの実践ガイド。
アーキテクチャの構造・設計思想は [architecture.md](architecture.md) に委ねる。
本ドキュメントは「何を・どの順番で・どのルールに従ってやるか」を定義する。

## 技術スタック

### ランタイム依存

| パッケージ | 用途 |
|-----------|------|
| Python 3.13 | 言語ランタイム |
| uv | パッケージマネージャ・仮想環境管理 |
| typer | CLIフレームワーク（コマンド・オプション定義） |
| pydantic | データバリデーション（外部データのマッピングと検証） |
| pydantic-settings | 環境変数からの設定読み込み |
| colorlog | カラー付きログ出力 |

### 開発ツール

| パッケージ | 用途 |
|-----------|------|
| ruff | Linter・フォーマッタ（コードスタイルの統一と静的解析） |
| pyright | 型チェッカー（静的型解析） |
| pytest | テストランナー |
| pytest-mock | モック・スタブのユーティリティ |
| pytest-cov | カバレッジ計測 |
| vulture | デッドコード検出 |

## 開発コマンド

### コマンド一覧

| コマンド | 説明 |
|---------|------|
| `make all` | format + lint + typecheck + test-unit の一括実行 |
| `make fmt` | Ruff によるコードフォーマット |
| `make lint` | Ruff による静的解析（自動修正あり） |
| `make typecheck` | Pyright による型チェック |
| `make test-unit` | ユニットテスト実行（`tests/unit/`） |
| `make test-integration` | インテグレーションテスト実行（`tests/integration/`） |
| `make coverage` | カバレッジ計測（HTML + ターミナル出力） |
| `make sync` | 依存パッケージのインストール（オフライン） |
| `make upgrade` | 依存パッケージを最新版に更新（`uv.lock` を更新） |

### 運用ルール

- コードを変更したら必ず `make all` を通す
- `make all` が通らない状態でコミットしない
- カバレッジは `make coverage` で計測する（`make all` には含まれないため明示的に実行する）

## 開発規律（Key Principles）

### TDD（テストファースト）

実装コードより先にテストを書く。Red → Green → Refactor のサイクルを守る。
テストなしで実装を書き始めてはいけない。

### カバレッジ 100%

`make coverage` で計測し、未カバーのコードは残さない。
カバレッジを下げるくらいなら実装しない（YAGNI原則と整合する）。

### テストコードの品質

テストコードはプロダクションコードと同様の品質を維持する。
テストコードもリファクタリングの対象であり、常に改善し続けるものである。

以下は改善対象の例:

- 読みづらいテストコード（意図が伝わらない命名・構造）
- デッドコード（実行されないテストや未使用のヘルパー）
- 重複するテストケース（同じ観点を複数のテストでカバーしている）

テストコードを変更した際は `make coverage` でカバレッジが維持されていることを確認する。

### 型ヒント必須

すべての関数・メソッドに型ヒントを付ける。
`make typecheck`（Pyright）が通ることを確認する。
型ヒントのない関数は `reportUnknownParameterType` でエラーになる。

### 日本語 OK

コメント・docstring は日本語で書いてよい。
ruff の設定（`RUF001/002/003` 無効化）で日本語文字列・コメントを許可済み。

### テストの独立性（ユニットテスト）

外部依存（FS・DB・外部API）を持たない。
Protocol + Fake（テスト用偽実装）で分離する。
`tests/unit/` に配置する。

### テストの独立性（インテグレーションテスト）

外部ネットワーク（外部APIなど）のみ分離する。
FS・DBなどプロジェクト管理下にある依存へのアクセスは実施する。
`tests/integration/` に配置する。

## 開発フロー

### 実装前（理解フェーズ）

1. `llms.txt` を読み、タスクに関連するドキュメントを特定する
2. 対象モジュールの `docs/specs/` を読む（`requirements.md` → `design.md` の順）
3. リファレンス実装 `src/example/transform/` を確認する

### 実装中（TDD サイクル）

1. **Red**: 失敗するテストを書く
2. **Green**: テストを通す最小限の実装をする
3. **Refactor**: `make all` を通しながらコードを整理する

このサイクルを小さく回す。一度に大量の実装を書かない。

### 実装後（後処理）

1. `make all` が全て通ることを確認する
2. 実装内容と `docs/specs/` の乖離があれば同期タスクを追加する
