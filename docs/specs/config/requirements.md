# config パッケージ要件定義書

## 概要

### 目的

アプリケーションの設定値が各コンポーネントに分散することを防ぐため、環境変数・デフォルト値・パス情報を一元管理し、実行時設定として提供する。これにより、設定の取得方法と利用方法が明確に分離され、環境差異への対応が容易になる。

### 解決する課題

- 環境変数の読み込みと設定値の利用が各コンポーネントに散在し、設定の管理・変更コストが増大する
- 環境変数が未設定の場合のデフォルト値の決定ロジックが各所で重複する
- パス情報（一時ディレクトリなど）の構築ルールが複数箇所に定義され、一貫性が保てない
- 設定値のバリデーション（ログレベルの許容値など）を呼び出し元が個別に実装する必要がある

### コンポーネントの概要

以下の 3 つのコンポーネントを提供する。

- **環境変数設定**: `EXAMPLE_` プレフィックスの環境変数を読み込み、バリデーション済みの設定値を提供する
- **パス設定**: ベースディレクトリからアプリケーションが使用するパス情報（一時ディレクトリなど）を構築する
- **アプリケーション設定**: 環境変数設定とパス設定を合成し、実行時に使用する最終的な設定値を提供する

## 機能要件

### 環境変数の読み込みとバリデーション

`EXAMPLE_` プレフィックスの環境変数を読み込み、バリデーション済みの設定値として提供する。

- `EXAMPLE_LOG_LEVEL` 環境変数からログレベルを取得できる
  - 許容値: `CRITICAL` / `ERROR` / `WARNING` / `INFO` / `DEBUG`
  - デフォルト値: `INFO`
  - 不正な値が設定されている場合はバリデーションエラーを送出する
- `EXAMPLE_TMP_DIR` 環境変数から一時ディレクトリパスを取得できる
  - 未設定の場合は `None` を返す
  - 設定されている場合は `pathlib.Path` オブジェクトに変換して返す
- 環境変数名の大小文字を区別しない（`EXAMPLE_LOG_LEVEL` と `example_log_level` を同一視する）
  - 大小文字の正規化はバリデーションより先に行う
- `EXAMPLE_` プレフィックスを持つ未定義の環境変数は拒否する（正規化後のキー名で判定する）

### パス情報の構築

ベースディレクトリからアプリケーションが使用するパス情報を構築する。

- ベースディレクトリを受け取り、標準的なパス構成を生成できる
  - 一時ディレクトリ: `{base_dir}/tmp`

### 実行時設定の合成

環境変数設定とパス設定を合成し、実行時に使用する最終的な設定値を提供する。

- 環境変数設定を受け取り、実行時設定を生成できる
- 一時ディレクトリの決定ルール:
  - `EXAMPLE_TMP_DIR` が設定されている場合: その値を使用する
  - `EXAMPLE_TMP_DIR` が未設定の場合: 実行時のカレントディレクトリを基にパス設定が生成した値を使用する

## 品質要件

### 不変性

設定オブジェクトは生成後に変更できない。一度構築された設定値はアプリケーションライフサイクル全体で不変であること。

### 早期バリデーション

環境変数の値はアプリケーション起動時に検証される。不正な値は実行前に検出され、設定不備によるランタイムエラーを防ぐ。

### 明示的なデフォルト値

環境変数が未設定の場合に使用されるデフォルト値は、コード上で明示的に宣言される。暗黙的なデフォルト値は設けない。

## 前提条件

### 技術基盤

- Python 標準ライブラリのパス操作機能を使用する
- `pydantic-settings` ライブラリを使用して環境変数の読み込み・型変換・バリデーションを行う

### 利用シナリオ

- アプリケーション起動時に 1 回だけ生成し、各コマンドへ渡す
- 生成された実行時設定の各フィールドは、他のパッケージの実行時パラメータ構築に使用される

## 関連ドキュメント

- [config パッケージ基本設計](./design.md): config パッケージのアーキテクチャ設計やコンポーネント構成
