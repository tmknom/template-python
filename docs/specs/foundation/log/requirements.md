# foundation/log 要件定義書

## 概要

### 目的

ロギングの設定と関数トレースが各コンポーネントに分散することを防ぐため、これらを基盤として一元提供する。これにより、アプリケーション全体で一貫したログ出力が実現される。

### 解決する課題

- 環境ごとに異なるログ形式（開発環境での視認性、本番環境での解析しやすさ）を手動で管理する手間がかかる
- ロガーの初期化を複数箇所で行うと設定が競合し、重複ログや設定漏れが発生する
- 関数・メソッドの呼び出し情報を個別に記録するコードが各所に散在し、保守コストが増大する
- 大量データを含む引数や戻り値をそのままログに出力するとログが肥大化し、確認が困難になる

### コンポーネントの概要

ログ設定の一元管理機能と、関数・メソッド呼び出しのトレース機能の 2 つを提供する。

ログ設定機能はアプリケーション起動時に 1 回だけ呼び出され、出力形式・出力先・ログレベルを実行環境（ローカル開発と CI/本番）に応じて構成する。構成後は Python 標準のロギング機構がそのまま利用できる。

トレース機能はデコレータとして提供され、関数・メソッドへの付与のみで呼び出し時の引数と戻り値を自動的にログ出力できる。

## 機能要件

### 環境別ログ設定

実行環境に応じて、以下の2種類のログ設定を切り替えられる。

#### ローカル開発向け設定
- コンソール（標準エラー出力）へのカラー表示でログを出力できる
- ファイルへのログ出力を同時に行える
- ファイルにはコンソールより低いログレベル（より詳細な）ログを記録できる
- ログファイルはアプリケーション名と起動日時を含む名前で生成される

#### CI/本番環境向け設定
- JSON 形式のログを標準出力へ出力できる
- カスタムの JSON フォーマッターを注入できる
- ファイルへの出力は行えない（標準出力のみ）

### 重複初期化の防止

ログ設定は1回のみ有効に適用される。すでにログハンドラーが設定済みの場合、再設定は行われない。これにより、複数モジュールや複数回の呼び出しによる設定の競合を防げる。

### 警告キャプチャ

Python の `warnings` モジュールが発行する警告を、ロギング機構経由で記録できる。これにより、アプリケーションログと警告を統一した方法で確認できる。

### 関数・メソッド呼び出しのトレース

デコレータを付与した関数・メソッドについて、呼び出し時の情報を自動的にログ出力できる。

- 関数・メソッドの開始時に、呼び出し元の識別子（クラス名.メソッド名 または 関数名）と引数をログ出力できる
- 関数・メソッドの終了時に、戻り値をログ出力できる
- 例外が発生した場合はログ出力を行わず、例外をそのまま呼び出し元に伝播する

### 大量データの要約表示

ログに出力する引数・戻り値が大量データを含む場合、要約形式で表示できる。これによりログの肥大化を防ぎつつ、デバッグに必要な最低限の情報を確認できる。要約の対象と条件は次の通り。

- リスト・タプル: 要素数が閾値以上の場合、先頭1要素と総件数を表示
- 辞書: キー数が閾値以上の場合、先頭1キー・値ペアと総件数を表示
- 文字列: 文字数が閾値以上の場合、先頭部分と総文字数を表示

閾値の具体的な値は設計書で定義する。

## 品質要件

### 設定の一貫性

アプリケーション内で有効なログ設定は常に1つであること。複数のコンポーネントが同じロガーを利用した場合も、出力形式・出力先・ログレベルが一貫していること。

### 関数の透過性

トレースデコレータを付与した関数・メソッドは、デコレータがない場合と同一の動作を保つこと。引数・戻り値の型、例外の伝播がデコレータによって変化しないこと。

### ログ出力の制御可能性

ログ出力のレベルを指定でき、出力内容の詳細度をコントロールできること。

## 前提条件

### 技術基盤

- Python 標準の `logging` モジュールを基盤として利用する
- ローカル環境向けのカラー表示には `colorlog` ライブラリを使用する

## 関連ドキュメント

- [foundation/log パッケージ基本設計](./design.md): foundation/log パッケージのアーキテクチャ設計やコンポーネント構成
